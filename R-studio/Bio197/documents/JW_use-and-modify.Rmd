---
title: "JW_Use-and-modify"
author: "James Waterford"
date: "2023-04-04"
output: html_document
---

```{r setup, include=FALSE}
library(dplyr)
knitr::opts_chunk$set(echo = TRUE)
```
The `apply` function allows us to apply a function to a vector or list of values iteratively. 
This helps minimize errors in code and makes the analyses more efficient.

`sapply()` simplifies an output to a vector.

`lapply()` returns an output in the form of a list.

`mapply()` applies FUN to the first elements of each ... argument.


We will show them in action soon. But first, let's prepare a full data set to work with.


## Calculating the mass of a bunch of dinosaurs.

Earlier, we practiced creating functions that take a single variable and modify it. 

Now we are going to add onto this, by manipulating entire vectors through a function.

First we will create a basic function that returns the theoretical mass, based on the given length of limb from the dinosaur, *Theropoda*.
```{r function}
mass_from_length_theropoda <- function(length){
  mass <- 0.73*length^3.63
  return(mass)
}
```

# Theropda lengths
Now that we've created a function, let's test it with a list of values.

First, we will generate a vector of lengths before we run it through our function.
```{r}
theropoda_lengths <- c(17.8013631070471, 20.3764452071665, 14.0743486294308, 25.65782386974, 26.0952008049675, 20.3111541103134, 17.5663244372533, 11.2563431277577, 20.081903202614, 18.6071626441984, 18.0991894513166, 23.0659685685892, 20.5798853467837, 25.6179254233558, 24.3714331573996, 26.2847248252537, 25.4753783544473, 20.4642089867304, 16.0738256364701, 20.3494171706583, 19.854399305869, 17.7889814608919, 14.8016421998303, 19.6840911485379, 19.4685885050906, 24.4807784966691, 13.3359960054899, 21.5065994598917, 18.4640304608411, 19.5861532398676, 27.084751999756, 18.9609366301798, 22.4829168046521, 11.7325716149514, 18.3758846100456, 15.537504851634, 13.4848751773738, 7.68561192214935, 25.5963348603783, 16.588285389794)

mass_from_length_theropoda(theropoda_lengths)
```
While this is functional, it is is very limited. We are relying on two coefficients--let's call them `a` and `b` to be constant through all samples. 

More likely, `a` and `b` are two coefficients that need to change. So let's add them as variables now.


```{r}
mass_from_length <- function(length, a, b){
  ## We use the `<<-` assignment operator to make a global variable ##
  mass <- a * length^b
  dino_data <<- data.frame(length)
  ## Then we create a column for mass
  dino_data %>% 
    mutate(mass = mass_from_length_theropoda(theropoda_lengths)) ->> dino_data
  return(dino_data)
} ## Here we will concatenate vectors for `a` and `b` ##
a_values <- c(0.759, 0.751, 0.74, 0.746, 0.759, 0.751, 0.749, 0.751, 0.738, 0.768, 0.736, 0.749, 0.746, 0.744, 0.749, 0.751, 0.744, 0.754, 0.774, 0.751, 0.763, 0.749, 0.741, 0.754, 0.746, 0.755, 0.764, 0.758, 0.76, 0.748, 0.745, 0.756, 0.739, 0.733, 0.757, 0.747, 0.741, 0.752, 0.752, 0.748)

b_values <- c(3.627, 3.633, 3.626, 3.633, 3.627, 3.629, 3.632, 3.628, 3.633, 3.627, 3.621, 3.63, 3.631, 3.632, 3.628, 3.626, 3.639, 3.626, 3.635, 3.629, 3.642, 3.632, 3.633, 3.629, 3.62, 3.619, 3.638, 3.627, 3.621, 3.628, 3.628, 3.635, 3.624, 3.621, 3.621, 3.632, 3.627, 3.624, 3.634, 3.621)

mass_from_length(length = theropoda_lengths, a = a_values, b = b_values)
```
## Lengthy Conditions


If we have values that are outside of the normal range, we can try to remove them with `IF/ELSE` functions.

```{r error=TRUE}
mass_from_length_max <- function(length) {
  if(length < 20) {
    mass <- 0.73*length^3.63
    } else { 
      mass <- NA
    }
  return(mass)
}
mass_from_length_max(length = theropoda_lengths)
```
Hmm. So why didn't that work. Well this program just tested all the values at the exact same time. Because we have *theropoda_lengths* as a `vector`, we need to call a function that will evaluate each value individually.

`sapply()` is our best choice for working with vectors (as opposed to a data frame).
The general rule: `sapply(FUNCTION, X...,)`

```{r}
sapply(theropoda_lengths,mass_from_length_max)
```
## A Data Set of Dinosaur Lengths

from https://lunasare.github.io/spring2023-data-science/exercises/Loops-size-estimates-by-name-apply-R/

```{r}
dino_dat <- read.csv("../197-raw_storage/dinosaur_lengths.csv")
```


```{r}
get_mass_from_length_by_name <-function(length,name){
  if(name == "Stegosauria"){
    a = 10.95
    b = 2.64
  }
  else if(name == "Theropoda"){
    a = 0.73
    b = 3.63
  }
  else if(name == "Sauropoda"){
    a = 214.44
    b = 1.46
  }
  else{
    a = NA
    b = NA
  }
  mass <- a * length^b
  
}
```

```{r}

mapply(get_mass_from_length_by_name, length = dino_dat$lengths, name = dino_dat$species) -> dino_mass

dino_dat %>% 
  rowwise() %>% 
  mutate(masses = get_mass_from_length_by_name(lengths,species)) -> dino_dat

```

```{r}

library(ggplot2)
dino_dat %>%
  filter(!is.na(masses)) %>% 
  ggplot() +
  geom_histogram(mapping = aes(x=masses,color = species)) +
  facet_wrap(~species)
```

