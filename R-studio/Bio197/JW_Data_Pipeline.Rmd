---
title: "JW_Data_Pipelines"
author: "James Waterford"
date: "2023-03-07"
output:
  pdf_document: default
  html_document: default
  word_document: default
---
```{r}
library(dplyr)
```
## There are two main ways to run a code:

### Nested Code


This method involves running mulitple codes in a single line.
```{r}
numbers <- 1:300
mean(numbers)
sqrt(mean(numbers))
```

### Sequential Code


This method generates intermediate variables to perform statistics on.

```{r}
numbers <- -300:456
mn <- mean(numbers)
sqrt(mn)
```

```{r}
library(readr)
surveys <- read_csv("197-raw_storage/surveys.csv")
species_data <- read.csv( "197-raw_storage/species.csv")
plots_data <- read.csv("197-raw_storage/plots.csv")
```


```{r dplyr, echo=FALSE}
library(dplyr)
surveys1 <- select(surveys, year, month, day, species_id)
head(surveys1)

select(surveys, year, species_id, weight) |>
mutate(weight_kg = weight*1000) |>
arrange(weight_kg) -> surveys2
head(surveys2)

```

## Pipe 

Pipes can be implemented in R with the `dplyr` package, and the `margittr` package.

The orginal symbol of the pipe is `%>%`. 
However, we can also use `|>` for the same effect. 
The purpose of this pipe is to eliminate or reduce the need of intermediate variables. R Studio includes a shortcut for the pipe: `cmd + shft + m`


```{r pipe}
library(magrittr)
1:300 |> mean() |> sqrt() -> mean_square
```

When we use a pipeline, we don't need to plug in the variable name every time.
This was a good practice run, but let's load some real data now.

Let's calculate the median year of surveys.
``` {r}
library(readr)
surveys <- read_csv("197-raw_storage/surveys.csv")
surveys$year %>% median()
```
Let's try calculating the mean of the weight. Because there are NAs in our weight column, we'll need to remove these.
```{r}
surveys$weight |> mean(na.rm=TRUE)
```

## Data Manipulation Practice

Sometimes it is much easier to run keep editing a data set, until it matches your intentions.

```{r piping it}

surveys2 <- select(surveys, year, species_id, weight) |> 
  mutate(weight_kg = weight/1000) |> 
  filter(!is.na(weight_kg)) |>
  select(year, species_id, weight_kg)

str(surveys2)
# surveys[ , c(1,3)]
# surveys[ , c("year", "weight_kg")]
```

Let's try one more example
---------------------------

The following code is written using intermediate variables. It obtains the data for "DS" in the "species_id" column, sorted by year, with only the year and weight columns. Write the same code to get the same output but using pipes instead.

`ds_data <- filter(surveys, species_id == "DS", !is.na(weight))
ds_data_by_year <- arrange(ds_data, year)
ds_weight_by_year <- select(ds_data_by_year, year, weight) `

``` {r pipe exercise 3}
filter(surveys, species_id == "DS", !is.na(weight)) |>
  arrange(year) |>
  select(year, weight) -> ds_data_by_year
  head(ds_data_by_year) 

```
What if I want to pipe to an argument other than the first argument?
------------


```{r unpiped}
str(surveys)
lm(formula = weight ~ year, data = surveys)
```
Sometimes, us coders are lazy. We don't want to put in every variable detail if we can avoid it. So we use the pipeline.
```{r piped, eval = FALSE}
surveys %>% 
  lm(formula = weight ~ year, data = _)
##This code will not run becuase we called data incorrectly##
surveys %>% 
  lm(formula = weight ~ year, data = .)
surveys |>  
  lm(formula = weight ~ year, data = _)

```
Piping Placeholders
------------

```{r}

filter(surveys, species_id == "DS", !is.na(weight)) %>% 
  lm(formula = weight ~ year, data = .) %>% 
  summary()
  
```
## Data Grouping / Data Aggregation

The function `group_by()` combines rows based on *matching columns*.
`group_by([data], [column])`
```{r Data Agg}

group_by(surveys,year)

surveys %>% 
group_by(year) 

surveys %>% 
group_by(sex, year) %>% 
  summarize()
```
Okay, this is an alright tool, but it's better when we know how to use it.

```{r}

group_by(surveys, sex, year) %>% 
  summarize(count = n())

group_by(surveys, sex, year) %>% 
  summarize(mean = mean(weight, na.rm = TRUE))

```

```{r}
surveys %>% 
  group_by(species_id) %>% 
  summarize(count = n())

surveys %>% 
  group_by(species_id, year) %>% 
  summarize(count = n())

surveys %>% 
  filter(species_id == "DO") %>% 
  group_by(year) %>% 
  summarize(mean = mean(weight, na.rm = TRUE))

```

